<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSICAL CALCULATOR</title>
    <script src="https://chonggi-tokhu.github.io/files/kin_choice/new/ColourgreyShorterCSSJS-0.0.1.js"></script>
    <script src="./midi_reader.js"></script>
    <script src="./midi_player.js"></script>
    <script src="./parsed_midi_to_json.js"></script>
    <script src="./player.js"></script>
    <script src="./musical-calculator.js"></script>
    <script
        src="https://chonggi-tokhu.github.io/svg_to_video/google_translate_meme_maker/ColourgreyShorterCSSJS.js"></script>
    <link rel="stylesheet"
        href="https://chonggi-tokhu.github.io/svg_to_video/google_translate_meme_maker/ColourgreyShorter.css">
    <style>
        .musical-calculator {
            height: 14em;
            background: silver;
            width: fit-content;
            padding: 0.5rem;
            border-radius: 6%;
            box-shadow: 2px 2px 1px 1px #000000, -2px -2px 1px 1px #000000, 2px -2px 1px 1px #000000, -2px 2px 1px 1px #000000;
        }

        .musical-calculator tr td {
            margin: 0.5rem;
            border-radius: 8vmax;
        }

        .musical-calculator>div>div>div {
            height: 1em;
            margin: 0.1rem;
            margin-top: 0.5em;
            min-width: 2rem;
        }

        .musical-calculator>div>div>div>span {
            border: 1px solid #000000;
            border-radius: 8vmax;
            min-width: 2rem;
            display: block;
            margin-top: 0.5em;
            text-align: center;
        }

        .calculators {
            display: flex;
        }

        .calculators .musical-calculator {
            margin-left: 1rem;
            margin-top: 1em;
        }

        .highlight {
            border: 1px solid #000000;
            border-radius: 8vmax;
            min-width: 2rem;
            display: block;
            margin-top: 0.5em;
            text-align: center;
            background: #557799 !important;
            color: #ffffff !important
        }
    </style>
</head>

<body>
    <div class="body">
        <div class="input-group">
            <input type="file" id="myfile"> <label for="myfile">연주</label>
        </div>
        <div class="calculators">
            <!-- <table class="musical-calculator">
            <tbody>
                <tr>
                    <td colspan="10" rowspan="2">
                        <div contenteditable="true" style="background: #1c873c;color:#000000">1972-11-21</div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2"><span style="background: lightgrey;color:#222222;">O</span></td>
                    <td colspan="2"><span style="background: black;color:white;">音量</span></td>
                    <td colspan="2"><span style="background: black;color:white;">時間</span></td>
                    <td colspan="2"><span style="background: black;color:white;">鬧鈴</span></td>
                    <td colspan="2"><span style="background: darkred;color:white;">AC</span></td>
                </tr>
                <tr>
                    <td colspan="2"><span style="background: blue;color:white;">M+</span></td>
                    <td colspan="2"><span style="background: blue;color:white;">M-</span></td>
                    <td colspan="2"><span style="background: blue;color:white;">MRC</span></td>
                    <td colspan="2"><span style="background: darkred;color:white;">CE</span></td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">7</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">8</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">9</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">GT</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">→</span></td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">4</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">5</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">6</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">×</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">÷</span></td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">1</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">2</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">3</span></td>
                    <td colspan="2" rowspan="4"><span style="background: white;color:black;">+</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">-</span></td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">0</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">00</span></td>
                    <td colspan="2" rowspan="2"><span style="background: black;color:white;">.</span></td>
                    <td colspan="2" rowspan="2"><span style="background: white;color:black;">=</span></td>
                </tr>
            </tbody>
        </table> -->
            <div class="musical-calculator" id="musical-calculator-left" tabindex="0">
                <div>
                    <div style="display: flex;">
                        <div contenteditable="true"
                            style="background: #1c873c;color:#000000;width: 100%;height: 1.5em;margin-left: 0.5rem;margin-right: 0.5rem;">
                            1972-11-21</div>
                    </div>
                    <div style="display: flex;">
                        <div class="calc-button" style="height: 2em;"><span
                                style="background: lightgrey;color:#222222;height: 2.4em;display: block;width: 2rem;">O</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;">音量</span></div>
                        <div class="calc-button"><span style="background: black;color:white;">時間</span></div>
                        <div class="calc-button"><span style="background: black;color:white;">鬧鈴</span></div>
                        <div class="calc-button"><span style="background: darkred;color:white;">AC</span></div>
                    </div>
                    <div style="display:flex;position: relative;left: 2.2rem;">
                        <div class="calc-button"><span style="background: blue;color:white;">M+</span></div>
                        <div class="calc-button"><span style="background: blue;color:white;">M-</span></div>
                        <div class="calc-button"><span style="background: blue;color:white;">MRC</span></div>
                        <div class="calc-button"><span style="background: darkred;color:white;"
                                data-button-key="CE">CE</span></div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="B4"
                                data-button-idx="6" data-button-key="7">7</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="C5"
                                data-button-idx="7" data-button-key="8">8</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="D5"
                                data-button-idx="8" data-button-key="9">9</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;">GT</span></div>
                        <div class="calc-button"><span style="background: white;color:black;">→</span></div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="F4"
                                data-button-idx="3" data-button-key="4">4</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="G4"
                                data-button-idx="4" data-button-key="5">5</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="A4"
                                data-button-idx="5" data-button-key="6">6</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="G5"
                                data-button-idx="11" data-button-key="*">×</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="A5"
                                data-button-idx="12" data-button-key="/">÷</span>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="C4"
                                data-button-idx="0" data-button-key="1">1</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="D4"
                                data-button-idx="1" data-button-key="2">2</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="E6"
                                data-button-idx="2" data-button-key="3">3</span>
                        </div>
                        <div class="calc-button"><span
                                style="background: white;color:black;position: absolute;height: 3em;"
                                data-button-name="E5" data-button-idx="9" data-button-key="+">+</span></div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="F5"
                                data-button-idx="10" data-button-key="-">-</span>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key="0">0</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key="00">00</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key=".">.</span>
                        </div>
                        <div class="calc-button">__</div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="B5"
                                data-button-idx="13" data-button-key="=">=</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="musical-calculator" id="musical-calculator-right" tabindex="1">
                <div>
                    <div style="display: flex;">
                        <div contenteditable="true"
                            style="background: #1c873c;color:#000000;width: 100%;height: 1.5em;margin-left: 0.5rem;margin-right: 0.5rem;">
                            1972-11-21</div>
                    </div>
                    <div style="display: flex;">
                        <div class="calc-button" style="height: 2em;"><span
                                style="background: lightgrey;color:#222222;height: 2.4em;display: block;width: 2rem;">O</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;">音量</span></div>
                        <div class="calc-button"><span style="background: black;color:white;">時間</span></div>
                        <div class="calc-button"><span style="background: black;color:white;">鬧鈴</span></div>
                        <div class="calc-button"><span style="background: darkred;color:white;">AC</span></div>
                    </div>
                    <div style="display:flex;position: relative;left: 2.2rem;">
                        <div class="calc-button"><span style="background: blue;color:white;">M+</span></div>
                        <div class="calc-button"><span style="background: blue;color:white;">M-</span></div>
                        <div class="calc-button"><span style="background: blue;color:white;">MRC</span></div>
                        <div class="calc-button"><span style="background: darkred;color:white;"
                                data-button-key="CE">CE</span></div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="B4"
                                data-button-idx="6" data-button-key="7">7</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="C5"
                                data-button-idx="7" data-button-key="8">8</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="D5"
                                data-button-idx="8" data-button-key="9">9</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;">GT</span></div>
                        <div class="calc-button"><span style="background: white;color:black;">→</span></div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="F4"
                                data-button-idx="3" data-button-key="4">4</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="G4"
                                data-button-idx="4" data-button-key="5">5</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="A4"
                                data-button-idx="5" data-button-key="6">6</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="G5"
                                data-button-idx="11" data-button-key="*">×</span>
                        </div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="A5"
                                data-button-idx="12" data-button-key="/">÷</span>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="C4"
                                data-button-idx="0" data-button-key="1">1</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="D4"
                                data-button-idx="1" data-button-key="2">2</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;" data-button-name="E6"
                                data-button-idx="2" data-button-key="3">3</span>
                        </div>
                        <div class="calc-button"><span
                                style="background: white;color:black;position: absolute;height: 3em;"
                                data-button-name="E5" data-button-idx="9" data-button-key="+">+</span></div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="F5"
                                data-button-idx="10" data-button-key="-">-</span>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key="0">0</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key="00">00</span>
                        </div>
                        <div class="calc-button"><span style="background: black;color:white;"
                                data-button-key=".">.</span>
                        </div>
                        <div class="calc-button">__</div>
                        <div class="calc-button"><span style="background: white;color:black;" data-button-name="B5"
                                data-button-idx="13" data-button-key="=">=</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <p>
            <h3>주의: 이 계산기는 계산을 할 수 없습니다. <span style="color:grey;text-decoration: line-through;">근데 정작 계산기 기능 구현보다 악기 기능
                    구현이 더 어려움</span></h3>
            </p>
            <p>
            <h3>설명서:</h3>
            </p>
            <p>

                <span>1 2 3 4 5 6 7 8 9 + - × ÷ 순서로 C3부터 D3, E4, F4... 순서로 올라갑니다.</span>
            </p>
            <p>
                <span> 오른쪽 계산기는 q w e r t y u i o p a s d f 순서로 C#3부터 D#3, F4, F#4, G#3... 순서로 올라갑니다.</span>
            </p>
        </div>
    </div>
    <script>
        var ColourgreyShorterJS = window['ColourgreyShorterJS'];
        var cgrcssjs = new ColourgreyShorterJS.ColourgreyShorterCSS(false);
        document.addEventListener("DOMContentLoaded", (ev) => {
            cgrcssjs.styleAll();
        });
        var hand = true;
        var AR7778 = window['AR7778'];
        var MidiPlayer = window['MidiPlayer'];
        var calculator = new AR7778({ length: 1000, semitone_up: false });
        var calculator_right = new AR7778({ length: 1000, semitone_up: true });
        calculator.init((inst) => {
            document.querySelectorAll(`#musical-calculator-left .calc-button span`).forEach((el, idx, parel) => {
                el.addEventListener("click", (ev) => {
                    //console.log(el.getAttribute("data-button-idx"));
                    calculator.playButton(Number(el.getAttribute("data-button-idx")), el, hand);
                });
                //console.log(el);
            });

        });
        calculator_right.init((inst) => {

            document.querySelectorAll(`#musical-calculator-right .calc-button span`).forEach((el, idx, parel) => {
                el.addEventListener("click", (ev) => {
                    //console.log(el.getAttribute("data-button-idx"));
                    calculator_right.playButton(Number(el.getAttribute("data-button-idx")), el, hand);
                });
                //console.log(el);
            });
        });
        var buttons_by_key = {
            '0': '0',
            '1': '1',
            '2': '2',
            '3': '3',
            '4': '4',
            '5': '5',
            '6': '6',
            '7': '7',
            '8': '8',
            '9': '9',
            'Enter': '+',
            '-': '-',
            '/': '/',
            '=': '=',
            '.': '.',
            'Shift': '*',
            'Backspace': 'CE',
        };

        var buttons_by_key_right = {
            'q': '0',
            'w': '1',
            'e': '2',
            'r': '3',
            't': '4',
            'y': '5',
            'u': '6',
            'i': '7',
            'o': '8',
            'p': '9',
            'a': '+',
            's': '-',
            'd': '*',
            'f': '/',
            'z': '=',
            'x': '.',
            'c': 'CE',
        };
        var buttons_by_notes = {
            'C3': '0',
            'D3': '1',
            'E3': '2',
            'F3': '3',
            'G3': '4',
            'A4': '5',
            'B4': '6',
            'C4': '7',
            'D4': '8',
            'E4': '9',
            'F4': '+',
            'G4': '-',
            'A5': '/',
            'B5': '*',
            'C5': '=',
            'C#3': 'q',
            'D#3': 'w',
            'F3': 'e',
            'F#3': 'r',
            'G#3': 't',
            'A#4': 'y',
            'B4': 'u',
            'C#4': 'i',
            'D#4': 'o',
            'F4': 'p',
            'F#4': 'a',
            'G#4': 's',
            'A#5': 'd',
            'B5': 'f',
            'C#5': 'z',
            'Db3': 'q',
            'Eb3': 'w',
            'F3': 'e',
            'Gb3': 'r',
            'Ab3': 't',
            'Bb4': 'y',
            'B4': 'u',
            'Db4': 'i',
            'Eb4': 'o',
            'F4': 'p',
            'Gb4': 'a',
            'Ab4': 's',
            'Bb5': 'd',
            'B5': 'f',
            'Db5': 'z',
        };
        var onplaying = {};
        document.querySelector('.calculators').addEventListener("keydown", (ev) => {
            var button = buttons_by_key[ev.key] || buttons_by_key_right[ev.key];
            var el = (Object.keys(buttons_by_key_right).includes(ev.key) ? document.querySelector('#musical-calculator-right') : document.querySelector('#musical-calculator-left')).getElementsByAttrValue("data-button-key", button)[0];
            if (!(el instanceof HTMLElement)) {
                return;
            }
            el.click();
        });
        var player = new midi_player();
        var myIntervals = { 0: false };
        function mySetInterval(cbfunc, interval, id) {
            if (!myIntervals[id]) { return id; }
            if (myIntervals[id] && typeof cbfunc === 'function') {
                setTimeout(() => { cbfunc(); mySetInterval(cbfunc, interval, id); }, interval);
            }
            return id;
        }
        function myClearInterval(id) {
            myIntervals[id] = false;
        }
        document.getElementById("myfile").addEventListener("change", (ev) => {
            var file = ev.target.files[0];
            var reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onloadend = (ev0) => {
                player.set_midi_arrayBuffer(reader.result);
                player.setTempo(80);
                hand = false;
                player = new MidiPlayer.Player(
                    (ev1) => {
                        player.setTempo(80);
                        console.log(ev1.noteName);
                        var button = buttons_by_key_right[buttons_by_notes[ev1?.noteName]] || buttons_by_key[buttons_by_notes[ev1?.noteName]];
                        var thisplayer;
                        if (ev1?.name === "Note on") {
                            thisplayer = (!(Object.keys(buttons_by_key_right).includes(button) || ev1?.noteName.includes("#"))) ? calculator : calculator_right;
                            //console.log(ev);
                            //console.log(button);
                            //document.querySelectorAll('.calculators span[data-button-key="' + button + '"]')[0].click();
                            var right = false;
                            if (ev1.noteName.includes("b")) {
                                thisplayer = calculator_right;
                                thisplayer.setConfig({ length: 1000, semitone_up: true });
                                right = true;
                            }
                            thisplayer.playButton(button, document.querySelectorAll('.calculators span[data-button-key="' + button + '"]')[right ? 1 : 0]);
                            /* 
                            if (Object.keys(buttons_by_notes).includes(ev1?.noteName)) {
                                onplaying[ev1.noteName] = mySetInterval(() => {
                                    document.querySelectorAll('.calculators span[data-button-key="' + button + '"]')[0].click();
                                }, calculator.config.length + 100, (myIntervals[Object.keys(myIntervals).length - 1]) + 1);
                            } */

                        } else if (ev1?.name==="Note off") {
                            thisplayer.stopButton(button, document.querySelector('.calculators span[data-button-key="' + button + '"]'));
                        } /*  else {

                        var buttonname = buttons_by_key[button] || buttons_by_key_right[button];
                        var thisplayer = (Object.keys(buttons_by_key_right).includes(button) ? calculator_right : calculator);
                        thisplayer.stopButton(button, document.querySelector('.calculators span[data-button-key="' + button + '"]'));
                        
                        if (Object.keys(buttons_by_notes).includes(ev1?.noteName) && (typeof onplaying[ev1.noteName] === "number")) {
                            myClearInterval(onplaying[ev1.noteName]);
                        } 
                    }*/

                    });
                player.loadArrayBuffer(reader.result);
                //player.parse_and_play_midi();
                player.play();
            }

        });
        cgrcssjs.styleAll();
    </script>
</body>

</html>